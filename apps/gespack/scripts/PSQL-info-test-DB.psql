-- =========================================================
-- SITES
-- =========================================================
INSERT INTO sites (site_name, site_description, contact_info, is_active)
VALUES ('MAYLIS', 'Maylis Promovent', 'info@maylis.com', TRUE)
ON CONFLICT (site_name) DO NOTHING;

INSERT INTO sites (site_name, site_description, contact_info, is_active)
VALUES ('MIRECAR', 'Mirecar', 'info@mirecar.com', TRUE)
ON CONFLICT (site_name) DO NOTHING;

INSERT INTO sites (site_name, site_description, contact_info, is_active)
VALUES ('INSPMUSEES', 'Inspiration Musees', 'info@museos.com', TRUE)
ON CONFLICT (site_name) DO NOTHING;

-- 2. Modificar tu script para usar bcrypt:
-- =========================================================
-- USERS + USER_SITE (con bcrypt)
-- =========================================================
INSERT INTO users (user_name, user_password, email, is_admin, is_active, created_by)
VALUES ('Iv√°n', crypt('P@rcel2025', gen_salt('bf')), 'ilopez@parcelontime.es', TRUE, TRUE, 1)
ON CONFLICT (email) DO NOTHING;

-- Vinculaciones b√°sicas (idempotentes)
INSERT INTO user_site (user_id, site_id)
SELECT u.user_id, s.site_id
FROM users u CROSS JOIN sites s
WHERE u.email = 'ilopez@parcelontime.es'
  AND s.site_name IN ('MAYLIS','MIRECAR','INSPMUSEES')
  AND NOT EXISTS (
    SELECT 1 FROM user_site us
    WHERE us.user_id = u.user_id AND us.site_id = s.site_id
  );

INSERT INTO users (user_name, user_password, email, is_admin, is_active, created_by)
VALUES ('Judith', crypt('P@rcel2025', gen_salt('bf')), 'jpuig@parcelontime.es', FALSE, TRUE, 1)
ON CONFLICT (email) DO NOTHING;

INSERT INTO user_site (user_id, site_id)
SELECT u.user_id, s.site_id
FROM users u
JOIN sites s ON s.site_name IN ('MAYLIS','MIRECAR')
WHERE u.email = 'jpuig@parcelontime.es'
  AND NOT EXISTS (SELECT 1 FROM user_site us WHERE us.user_id=u.user_id AND us.site_id=s.site_id);

-- Algunos usuarios inactivos de prueba (con bcrypt)
DO $$
DECLARE
  v_emails text[] := ARRAY[
    'sad1@parcelontime.es','sad2@parcelontime.es','sad3@parcelontime.es',
    'sad4@parcelontime.es','sad5@parcelontime.es','sad6@parcelontime.es',
    'sad7@parcelontime.es','sad8@parcelontime.es','sad9@parcelontime.es','sad10@parcelontime.es'
  ];
  v_idx int;
  v_user_id bigint;
  v_site_id bigint;
BEGIN
  FOR v_idx IN 1..array_length(v_emails,1) LOOP
    INSERT INTO users (user_name, user_password, email, is_admin, is_active, created_by)
    VALUES ('TEST '||v_idx, crypt('P@rcel2025', gen_salt('bf')), v_emails[v_idx], FALSE, FALSE, 1) -- üëà BCRYPT
    ON CONFLICT (email) DO NOTHING;

    SELECT user_id INTO v_user_id FROM users WHERE email = v_emails[v_idx];
    SELECT site_id INTO v_site_id FROM sites WHERE site_name='INSPMUSEES';

    IF v_user_id IS NOT NULL AND v_site_id IS NOT NULL THEN
      INSERT INTO user_site (user_id, site_id)
      SELECT v_user_id, v_site_id
      WHERE NOT EXISTS (
        SELECT 1 FROM user_site us WHERE us.user_id=v_user_id AND us.site_id=v_site_id
      );
    END IF;
  END LOOP;
END$$;

-- =========================================================
-- SEED PRINCIPAL (idempotente) ‚Äì order_sources, customer_types, brands x3
-- =========================================================
DO $$
DECLARE
  -- Obtener IDs reales de sites
  site_ids BIGINT[] := ARRAY[
    (SELECT site_id FROM sites WHERE site_name='MAYLIS' LIMIT 1),
    (SELECT site_id FROM sites WHERE site_name='MIRECAR' LIMIT 1),
    (SELECT site_id FROM sites WHERE site_name='INSPMUSEES' LIMIT 1)
  ];
  s BIGINT;

  -- BRANDS por site
  v_brand1_id bigint;  -- Albor
  v_brand2_id bigint;  -- Brava
  v_brand3_id bigint;  -- Cobalto

  v_category_id     bigint;
  v_priority_id     bigint;

  v_action_prim     bigint;
  v_action_ver      bigint;

  j                 int;         -- cliente 1..5
  v_customer_code   bigint;
  v_customer_id     bigint;

  v_order_ref       text;
  v_payment_id      bigint;
  v_order_id        bigint;

  v_amount          numeric(19,4);
  v_bi              numeric(19,4);
  v_tva             numeric(19,4);
  v_return_id       bigint;

  -- productos
  refA text; refB text; refC text; refD text; refE text; refF text; refG text;
  refCALT text; refEALT text;

  v_prod_id bigint;

  reserve_paid boolean;
  create_shipped boolean;
  create_invoiced boolean;

  -- Order sources y tipos de cliente
  v_source_web_id bigint;
  v_source_phone_id bigint;
  v_source_market_id bigint;
  v_source_pos_id bigint;

  v_ct_retail_id bigint;
  v_ct_wholesale_id bigint;
  v_ct_vip_id bigint;

  -- Nombres reales ficticios
  arr_first_names text[] := ARRAY['Luc√≠a','Mateo','Sof√≠a','Hugo','Valeria','Daniel','Paula','Leo','Martina','Pablo'];
  arr_last_names  text[] := ARRAY['Garc√≠a','Mart√≠nez','L√≥pez','S√°nchez','Fern√°ndez','G√≥mez','D√≠az','Ruiz','Hern√°ndez','Navarro'];
  v_fn text; v_ln text; idx int;

  -- Marca a usar por pedido (seg√∫n acci√≥n)
  v_brand_for_order bigint;

  -- usuario auditor
  v_created_by bigint := (SELECT user_id FROM users WHERE email='ilopez@parcelontime.es' LIMIT 1);
BEGIN
  FOREACH s IN ARRAY site_ids LOOP
    EXIT WHEN s IS NULL;

    --------------------------------------------------------------------
    -- 0) BRANDS x3 / CATEGORY / PRIORITY (idempotentes por site)
    --------------------------------------------------------------------
    -- Albor
    SELECT b.brand_id INTO v_brand1_id
    FROM brands b
    WHERE b.site_id = s AND b.brand_name = 'Albor';
    IF v_brand1_id IS NULL THEN
      INSERT INTO brands (site_id, brand_name, description, is_active, created_by)
      VALUES (s, 'Albor', 'Marca Albor', TRUE, v_created_by)
      RETURNING brand_id INTO v_brand1_id;
    END IF;

    -- Brava
    SELECT b.brand_id INTO v_brand2_id
    FROM brands b
    WHERE b.site_id = s AND b.brand_name = 'Brava';
    IF v_brand2_id IS NULL THEN
      INSERT INTO brands (site_id, brand_name, description, is_active, created_by)
      VALUES (s, 'Brava', 'Marca Brava', TRUE, v_created_by)
      RETURNING brand_id INTO v_brand2_id;
    END IF;

    -- Cobalto
    SELECT b.brand_id INTO v_brand3_id
    FROM brands b
    WHERE b.site_id = s AND b.brand_name = 'Cobalto';
    IF v_brand3_id IS NULL THEN
      INSERT INTO brands (site_id, brand_name, description, is_active, created_by)
      VALUES (s, 'Cobalto', 'Marca Cobalto', TRUE, v_created_by)
      RETURNING brand_id INTO v_brand3_id;
    END IF;

    -- Categor√≠a / prioridad
    SELECT c.action_category_id INTO v_category_id
    FROM action_categories c
    WHERE c.site_id = s AND c.category_name = 'CategoriaTest';
    IF v_category_id IS NULL THEN
      INSERT INTO action_categories (site_id, category_name, description, created_by)
      VALUES (s, 'CategoriaTest', 'Categor√≠a de prueba', v_created_by)
      RETURNING action_category_id INTO v_category_id;
    END IF;

    SELECT p.action_priority_id INTO v_priority_id
    FROM action_priority_types p
    WHERE p.site_id = s AND p.priority_name = 'NORMAL';
    IF v_priority_id IS NULL THEN
      INSERT INTO action_priority_types (site_id, priority_name, created_by)
      VALUES (s, 'NORMAL', v_created_by)
      RETURNING action_priority_id INTO v_priority_id;
    END IF;

    --------------------------------------------------------------------
    -- 0.1) ORDER_SOURCES (Web, Phone, Marketplace, POS)
    --------------------------------------------------------------------
    PERFORM 1 FROM order_sources WHERE site_id=s AND lower(source_name)='web';
    IF NOT FOUND THEN
      INSERT INTO order_sources (site_id, source_name, description, is_active, created_by)
      VALUES (s, 'Web', 'Pedido desde la web', TRUE, v_created_by);
    END IF;
    PERFORM 1 FROM order_sources WHERE site_id=s AND lower(source_name)='phone';
    IF NOT FOUND THEN
      INSERT INTO order_sources (site_id, source_name, description, is_active, created_by)
      VALUES (s, 'Phone', 'Pedido por tel√©fono', TRUE, v_created_by);
    END IF;
    PERFORM 1 FROM order_sources WHERE site_id=s AND lower(source_name)='marketplace';
    IF NOT FOUND THEN
      INSERT INTO order_sources (site_id, source_name, description, is_active, created_by)
      VALUES (s, 'Marketplace', 'Pedido importado de marketplace', TRUE, v_created_by);
    END IF;
    PERFORM 1 FROM order_sources WHERE site_id=s AND lower(source_name)='pos';
    IF NOT FOUND THEN
      INSERT INTO order_sources (site_id, source_name, description, is_active, created_by)
      VALUES (s, 'POS', 'Pedido en punto de venta', TRUE, v_created_by);
    END IF;

    SELECT order_source_id INTO v_source_web_id
    FROM order_sources WHERE site_id=s AND lower(source_name)='web' LIMIT 1;
    SELECT order_source_id INTO v_source_phone_id
    FROM order_sources WHERE site_id=s AND lower(source_name)='phone' LIMIT 1;
    SELECT order_source_id INTO v_source_market_id
    FROM order_sources WHERE site_id=s AND lower(source_name)='marketplace' LIMIT 1;
    SELECT order_source_id INTO v_source_pos_id
    FROM order_sources WHERE site_id=s AND lower(source_name)='pos' LIMIT 1;

    --------------------------------------------------------------------
    -- 0.2) CUSTOMER_TYPES (Retail, Wholesale, VIP)
    --------------------------------------------------------------------
    PERFORM 1 FROM customer_types WHERE site_id=s AND type_code=1;
    IF NOT FOUND THEN
      INSERT INTO customer_types (site_id, type_code, type_name, description, created_by)
      VALUES (s, 1, 'Retail', 'Cliente minorista est√°ndar', v_created_by);
    END IF;

    PERFORM 1 FROM customer_types WHERE site_id=s AND type_code=2;
    IF NOT FOUND THEN
      INSERT INTO customer_types (site_id, type_code, type_name, description, created_by)
      VALUES (s, 2, 'Wholesale', 'Cliente mayorista', v_created_by);
    END IF;

    PERFORM 1 FROM customer_types WHERE site_id=s AND type_code=3;
    IF NOT FOUND THEN
      INSERT INTO customer_types (site_id, type_code, type_name, description, created_by)
      VALUES (s, 3, 'VIP', 'Cliente VIP', v_created_by);
    END IF;

    SELECT customer_type_id INTO v_ct_retail_id
      FROM customer_types WHERE site_id=s AND type_code=1;
    SELECT customer_type_id INTO v_ct_wholesale_id
      FROM customer_types WHERE site_id=s AND type_code=2;
    SELECT customer_type_id INTO v_ct_vip_id
      FROM customer_types WHERE site_id=s AND type_code=3;

    --------------------------------------------------------------------
    -- 1) ACCIONES por site (Primavera/Verano)
    --    Primavera -> Albor (brand1)
    --    Verano    -> Brava (brand2)
    --------------------------------------------------------------------
    SELECT a.action_id INTO v_action_prim
    FROM actions a
    WHERE a.site_id = s AND a.action_name = 'Campa√±a Primavera';
    IF v_action_prim IS NULL THEN
      INSERT INTO actions (
        site_id, action_name, description, launch_date, brand_id, deposit_date,
        action_category_id, is_active, created_by
      )
      VALUES (s, 'Campa√±a Primavera', 'Promoci√≥n Primavera', NOW(), v_brand1_id, NOW(), v_category_id, TRUE, v_created_by)
      RETURNING action_id INTO v_action_prim;
    END IF;

    SELECT a.action_id INTO v_action_ver
    FROM actions a
    WHERE a.site_id = s AND a.action_name = 'Campa√±a Verano';
    IF v_action_ver IS NULL THEN
      INSERT INTO actions (
        site_id, action_name, description, launch_date, brand_id, deposit_date,
        action_category_id, is_active, created_by
      )
      VALUES (s, 'Campa√±a Verano', 'Promoci√≥n Verano', NOW(), v_brand2_id, NOW(), v_category_id, TRUE, v_created_by)
      RETURNING action_id INTO v_action_ver;
    END IF;

    --------------------------------------------------------------------
    -- 2) 5 CLIENTES por site + CATALOGO de productos por cliente
    --------------------------------------------------------------------
    FOR j IN 1..5 LOOP
      v_customer_code := s * 100000 + 1000 + j;

      -- Nombres reales ficticios
      idx := ((j - 1) % array_length(arr_first_names,1)) + 1;
      v_fn := arr_first_names[idx];
      v_ln := arr_last_names[idx];

      -- Elegir tipo de cliente (reutilizamos v_prod_id solo como holder)
      SELECT CASE
               WHEN j % 5 = 0 THEN v_ct_vip_id
               WHEN j % 2 = 0 THEN v_ct_wholesale_id
               ELSE v_ct_retail_id
             END
        INTO v_prod_id;

      -- Cliente
      SELECT cu.customer_id INTO v_customer_id
      FROM customers cu
      WHERE cu.site_id = s AND cu.customer_code = v_customer_code;

      IF v_customer_id IS NULL THEN
        INSERT INTO customers (
          site_id, customer_code, customer_type_id,
          customer_gender, customer_first_name, customer_last_name,
          -- Billing
          billing_first_name, billing_last_name, billing_address_line1, billing_address_cp, billing_address_city, billing_mobile_phone,
          -- Shipping (a√±adimos line2..4)
          shipping_first_name, shipping_last_name,
          shipping_address_line1, shipping_address_line2, shipping_address_line3, shipping_address_line4,
          shipping_address_cp, shipping_address_city, shipping_mobile_phone,
          email, is_active, created_by
        )
        VALUES (
          s, v_customer_code, v_prod_id,
          CASE WHEN j % 2 = 0 THEN 'F' ELSE 'M' END,
          v_fn, v_ln,
          -- Billing
          v_fn, v_ln, 'Calle ' || j, '2800' || j, 'Madrid', '60012345' || j,
          -- Shipping con direcciones variadas
          v_fn, v_ln,
          'Calle ' || j,
          'Piso ' || ((j % 6) + 1) || ' Esc. ' || chr(65 + (j % 3)),                          -- A, B, C...
          'Bloque ' || ((j % 4) + 1) || ' Puerta ' || lpad(((j % 20) + 1)::text, 2, '0'),     -- Puerta 01..20
          (ARRAY['Centro','Salamanca','Retiro','Usera','Latina','Chamart√≠n'])[(j % 6) + 1],
          '2800' || j, 'Madrid', '60012345' || j,
          lower(translate(v_fn,'√°√©√≠√≥√∫√Å√â√ç√ì√ö','aeiouAEIOU')) || '.' || lower(v_ln) || '+site' || s || '@example.com',
          true, v_created_by
        )
        RETURNING customer_id INTO v_customer_id;
      END IF;

      -- Refs de productos
      refA := 'PROD-A' || j; refB := 'PROD-B' || j; refC := 'PROD-C' || j; refD := 'PROD-D' || j;
      refE := 'PROD-E' || j; refF := 'PROD-F' || j; refG := 'PROD-G' || j;
      refCALT := 'PROD-CALT' || j; refEALT := 'PROD-EALT' || j;

      -- PRODUCTS idempotentes (A/B -> brand1; C/D/CALT -> brand2; E/F/G/EALT -> brand3)
      PERFORM 1 FROM products WHERE site_id=s AND product_ref=refA;
      IF NOT FOUND THEN
        INSERT INTO products (site_id, product_ref, catalog, brand_id, description, price, stock, created_by)
        VALUES (s, refA, 'CAT-A', v_brand1_id, 'Articulo A '||j, 35.00, 200, v_created_by);
      END IF;

      PERFORM 1 FROM products WHERE site_id=s AND product_ref=refB;
      IF NOT FOUND THEN
        INSERT INTO products (site_id, product_ref, catalog, brand_id, description, price, stock, created_by)
        VALUES (s, refB, 'CAT-B', v_brand1_id, 'Articulo B '||j, 20.00, 200, v_created_by);
      END IF;

      PERFORM 1 FROM products WHERE site_id=s AND product_ref=refC;
      IF NOT FOUND THEN
        INSERT INTO products (site_id, product_ref, catalog, brand_id, description, price, stock, created_by)
        VALUES (s, refC, 'CAT-C', v_brand2_id, 'Articulo C '||j, 22.00, 0, v_created_by);
      END IF;

      PERFORM 1 FROM products WHERE site_id=s AND product_ref=refD;
      IF NOT FOUND THEN
        INSERT INTO products (site_id, product_ref, catalog, brand_id, description, price, stock, created_by)
        VALUES (s, refD, 'CAT-D', v_brand2_id, 'Articulo D '||j, 30.00, 200, v_created_by);
      END IF;

      PERFORM 1 FROM products WHERE site_id=s AND product_ref=refE;
      IF NOT FOUND THEN
        INSERT INTO products (site_id, product_ref, catalog, brand_id, description, price, stock, created_by)
        VALUES (s, refE, 'CAT-E', v_brand3_id, 'Articulo E '||j, 28.00, 0, v_created_by);
      END IF;

      PERFORM 1 FROM products WHERE site_id=s AND product_ref=refF;
      IF NOT FOUND THEN
        INSERT INTO products (site_id, product_ref, catalog, brand_id, description, price, stock, created_by)
        VALUES (s, refF, 'CAT-F', v_brand3_id, 'Articulo F '||j, 40.00, 200, v_created_by);
      END IF;

      PERFORM 1 FROM products WHERE site_id=s AND product_ref=refG;
      IF NOT FOUND THEN
        INSERT INTO products (site_id, product_ref, catalog, brand_id, description, price, stock, created_by)
        VALUES (s, refG, 'CAT-G', v_brand3_id, 'Articulo G '||j, 32.00, 200, v_created_by);
      END IF;

      PERFORM 1 FROM products WHERE site_id=s AND product_ref=refCALT;
      IF NOT FOUND THEN
        INSERT INTO products (site_id, product_ref, catalog, brand_id, description, price, stock, created_by)
        VALUES (s, refCALT, 'CAT-CALT', v_brand2_id, 'Articulo C ALT '||j, 21.00, 0, v_created_by);
      END IF;

      PERFORM 1 FROM products WHERE site_id=s AND product_ref=refEALT;
      IF NOT FOUND THEN
        INSERT INTO products (site_id, product_ref, catalog, brand_id, description, price, stock, created_by)
        VALUES (s, refEALT, 'CAT-EALT', v_brand3_id, 'Articulo E ALT '||j, 27.00, 200, v_created_by);
      END IF;

      -- STOCK ENTRIES (idempotentes)
      FOR refA IN SELECT unnest(ARRAY[refA,refB,refC,refD,refE,refF,refG,refCALT,refEALT]) LOOP
        SELECT p.product_id INTO v_prod_id FROM products p WHERE p.site_id=s AND p.product_ref=refA;
        IF v_prod_id IS NOT NULL THEN
          PERFORM 1 FROM stock_entries se
          WHERE se.site_id=s AND se.product_id=v_prod_id AND se.invoice_or_delivery='SEED-'||s||'-'||v_prod_id;
          IF NOT FOUND THEN
            INSERT INTO stock_entries (
              site_id, product_id, reference, description, quantity, invoice_or_delivery,
              supplier, entry_date, worker, entry_type, created_by
            ) VALUES (
              s, v_prod_id, refA, 'Entrada seed '||refA, 100, 'SEED-'||s||'-'||v_prod_id,
              'Proveedor Seed', CURRENT_DATE, 'seed', 'IN', v_created_by
            );
          END IF;
        END IF;
      END LOOP;

      -- REGLAS DE SUSTITUTOS
      PERFORM 1 FROM product_substitutes WHERE site_id=s AND ref_start=refE AND ref_end=refEALT;
      IF NOT FOUND THEN
        INSERT INTO product_substitutes (
          site_id, ref_start, cat_start, desc_start, ref_end, cat_end, desc_end,
          max_quantity, used_quantity, expires_at, created_by, is_active
        ) VALUES (
          s, refE, 'CAT-E', 'Articulo E '||j, refEALT, 'CAT-EALT', 'Articulo E ALT '||j,
          999, 0, CURRENT_DATE + INTERVAL '90 days', v_created_by, TRUE
        );
      END IF;

      PERFORM 1 FROM product_substitutes WHERE site_id=s AND ref_start=refC AND ref_end=refCALT;
      IF NOT FOUND THEN
        INSERT INTO product_substitutes (
          site_id, ref_start, cat_start, desc_start, ref_end, cat_end, desc_end,
          max_quantity, used_quantity, expires_at, created_by, is_active
        ) VALUES (
          s, refC, 'CAT-C', 'Articulo C '||j, refCALT, 'CAT-CALT', 'Articulo C ALT '||j,
          999, 0, CURRENT_DATE + INTERVAL '90 days', v_created_by, TRUE
        );
      END IF;

      ----------------------------------------------------------------
      -- 3) PEDIDOS ‚Äì con order_source_id (usamos Web)
      --    Marca del pedido seg√∫n acci√≥n:
      --      - Si usa v_action_prim  -> v_brand1_id
      --      - Si usa v_action_ver   -> v_brand2_id
      ----------------------------------------------------------------
      reserve_paid :=
            (s = (SELECT site_id FROM sites WHERE site_name='MAYLIS') AND j IN (1,3))
         OR (s = (SELECT site_id FROM sites WHERE site_name='MIRECAR') AND j IN (2,3,4))
         OR (s = (SELECT site_id FROM sites WHERE site_name='INSPMUSEES'));

      create_shipped := NOT ( (s = (SELECT site_id FROM sites WHERE site_name='MIRECAR') AND j IN (1,2))
                              OR (s = (SELECT site_id FROM sites WHERE site_name='MAYLIS') AND j = 5) );
      create_invoiced := NOT ( (s = (SELECT site_id FROM sites WHERE site_name='INSPMUSEES') AND j = 5)
                               OR (s = (SELECT site_id FROM sites WHERE site_name='MAYLIS') AND j = 1) );

      -- (A) PENDING
      v_order_ref := 'S'||s||'-C'||j||'-PEN';
      v_brand_for_order := CASE WHEN (j%2=0) THEN v_brand1_id ELSE v_brand2_id END;
      v_amount    := 35.00; v_bi := round(v_amount/1.21, 2); v_tva := v_amount - v_bi;

      PERFORM 1 FROM orders o WHERE o.site_id=s AND o.order_reference=v_order_ref;
      IF NOT FOUND THEN
        INSERT INTO order_payments (site_id, order_id, payment_type, is_deferred, schedule_count, amount, created_by)
        VALUES (s, -1, 'efectivo', FALSE, 1, v_amount, v_created_by)
        RETURNING order_payments_id INTO v_payment_id;

        INSERT INTO orders (
          site_id, order_datetime, order_reference, brand_id, order_source_id,
          action_id, action_category_id, action_priority_id,
          shipping_cost, customer_id, first_name, last_name, payment_type_id,
          is_paid, paid_at, is_invoiced, invoiced_at, order_lines, order_amount, bi1, tva1,
          status, created_by
        )
        VALUES (
          s, NOW(), v_order_ref, v_brand_for_order, v_source_web_id,
          CASE WHEN j%2=0 THEN v_action_prim ELSE v_action_ver END, v_category_id, v_priority_id,
          3.50, v_customer_id, v_fn, v_ln, v_payment_id,
          FALSE, NULL, FALSE, NULL, 1, v_amount, v_bi, v_tva, 'pending', v_created_by
        )
        RETURNING order_id INTO v_order_id;

        UPDATE order_payments SET order_id=v_order_id
        WHERE site_id=s AND order_payments_id=v_payment_id;

        SELECT p.product_id INTO v_prod_id
        FROM products p WHERE p.site_id=s AND p.product_ref=refA;

        INSERT INTO order_items (
          site_id, order_id, line_number, product_id, product_ref, quantity,
          product_description, unit_price, line_total, created_by
        )
        VALUES (s, v_order_id, 1, v_prod_id, refA, 1, 'Articulo A'||j, v_amount, v_amount, v_created_by);
      END IF;

      -- (B) RESERVED
      v_order_ref := 'S'||s||'-C'||j||'-RES';
      v_brand_for_order := CASE WHEN reserve_paid THEN v_brand2_id ELSE v_brand1_id END;
      v_amount    := 42.00; v_bi := round(v_amount/1.21, 2); v_tva := v_amount - v_bi;

      PERFORM 1 FROM orders o WHERE o.site_id=s AND o.order_reference=v_order_ref;
      IF NOT FOUND THEN
        INSERT INTO order_payments (site_id, order_id, payment_type, is_deferred, schedule_count, amount, created_by)
        VALUES (s, -1, 'efectivo', FALSE, 1, v_amount, v_created_by)
        RETURNING order_payments_id INTO v_payment_id;

        INSERT INTO orders (
          site_id, order_datetime, order_reference, brand_id, order_source_id,
          action_id, action_category_id, action_priority_id,
          shipping_cost, customer_id, first_name, last_name, payment_type_id,
          is_paid, paid_at, is_invoiced, invoiced_at, order_lines, order_amount, bi1, tva1,
          status, created_by
        )
        VALUES (
          s, NOW() - INTERVAL '1 day', v_order_ref, v_brand_for_order, v_source_web_id,
          CASE WHEN reserve_paid THEN v_action_ver ELSE v_action_prim END, v_category_id, v_priority_id,
          4.00, v_customer_id, v_fn, v_ln, v_payment_id,
          reserve_paid, CASE WHEN reserve_paid THEN NOW() ELSE NULL END,
          FALSE, NULL, 2, v_amount, v_bi, v_tva, 'reserved', v_created_by
        )
        RETURNING order_id INTO v_order_id;

        UPDATE order_payments SET order_id=v_order_id
        WHERE site_id=s AND order_payments_id=v_payment_id;

        SELECT p.product_id INTO v_prod_id FROM products p WHERE p.site_id=s AND p.product_ref=refB;
        INSERT INTO order_items (site_id, order_id, line_number, product_id, product_ref, quantity, product_description, unit_price, line_total, created_by)
        VALUES (s, v_order_id, 1, v_prod_id, refB, 1, 'Articulo B'||j, 20.00, 20.00, v_created_by);

        SELECT p.product_id INTO v_prod_id FROM products p WHERE p.site_id=s AND p.product_ref=refC;
        INSERT INTO order_items (site_id, order_id, line_number, product_id, product_ref, quantity, product_description, unit_price, line_total, created_by)
        VALUES (s, v_order_id, 2, v_prod_id, refC, 1, 'Articulo C'||j, v_amount-20.00, v_amount-20.00, v_created_by);
      END IF;

      -- (C) SHIPPED
      v_order_ref := 'S'||s||'-C'||j||'-SHP';
      v_brand_for_order := v_brand1_id; -- p.ej. asocia a Primavera
      v_amount    := 58.00; v_bi := round(v_amount/1.21, 2); v_tva := v_amount - v_bi;

      PERFORM 1 FROM orders o WHERE o.site_id=s AND o.order_reference=v_order_ref;
      IF NOT FOUND THEN
        IF create_shipped THEN
          INSERT INTO order_payments (site_id, order_id, payment_type, is_deferred, schedule_count, amount, created_by)
          VALUES (s, -1, 'tarjeta', FALSE, 1, v_amount, v_created_by)
          RETURNING order_payments_id INTO v_payment_id;

          INSERT INTO orders (
            site_id, order_datetime, order_reference, brand_id, order_source_id,
            action_id, action_category_id, action_priority_id,
            shipping_cost, customer_id, first_name, last_name, payment_type_id,
            is_paid, paid_at, is_invoiced, invoiced_at, order_lines, order_amount, bi1, tva1,
            status, created_by
          )
          VALUES (
            s, NOW() - INTERVAL '2 days', v_order_ref, v_brand_for_order, v_source_web_id,
            v_action_prim, v_category_id, v_priority_id,
            5.00, v_customer_id, v_fn, v_ln, v_payment_id,
            TRUE, NOW() - INTERVAL '2 days', FALSE, NULL, 2, v_amount, v_bi, v_tva, 'shipped', v_created_by
          )
          RETURNING order_id INTO v_order_id;

          UPDATE order_payments SET order_id=v_order_id
          WHERE site_id=s AND order_payments_id=v_payment_id;

          SELECT p.product_id INTO v_prod_id FROM products p WHERE p.site_id=s AND p.product_ref=refD;
          INSERT INTO order_items (site_id, order_id, line_number, product_id, product_ref, quantity, product_description, unit_price, line_total, created_by)
          VALUES (s, v_order_id, 1, v_prod_id, refD, 1, 'Articulo D'||j, 30.00, 30.00, v_created_by);

          SELECT p.product_id INTO v_prod_id FROM products p WHERE p.site_id=s AND p.product_ref=refE;
          INSERT INTO order_items (site_id, order_id, line_number, product_id, product_ref, quantity, product_description, unit_price, line_total, created_by)
          VALUES (s, v_order_id, 2, v_prod_id, refE, 1, 'Articulo E'||j, v_amount-30.00, v_amount-30.00, v_created_by);

          IF NOT EXISTS (
            SELECT 1 FROM order_payment_schedules
            WHERE site_id=s AND order_payments_id=v_payment_id AND schedule_number=1
          ) THEN
            INSERT INTO order_payment_schedules (
              site_id, order_payments_id, schedule_number, amount, due_date, is_paid, paid_date, created_by
            ) VALUES (s, v_payment_id, 1, v_amount, NOW() - INTERVAL '2 days', TRUE, NOW() - INTERVAL '2 days', v_created_by);
          END IF;

          IF NOT EXISTS (
            SELECT 1 FROM returns r WHERE r.site_id=s AND r.order_reference=v_order_ref
          ) THEN
            INSERT INTO returns (site_id, order_reference, return_date, customer_code, created_by)
            VALUES (s, v_order_ref, NOW() - INTERVAL '1 day', v_customer_code, v_created_by)
            RETURNING return_id INTO v_return_id;

            INSERT INTO return_items (return_id, product_ref, quantity, reason, created_by)
            VALUES (v_return_id, refE, 1, 'No conforme', v_created_by);
          END IF;
        END IF;
      END IF;

      -- Sustituci√≥n en SHIPPED (E ‚Üí EALT)
      PERFORM 1 FROM orders o WHERE o.site_id=s AND o.order_reference='S'||s||'-C'||j||'-SHP';
      IF FOUND THEN
        SELECT oi.order_item_id INTO v_prod_id
        FROM order_items oi
        JOIN orders o ON o.order_id=oi.order_id AND o.site_id=oi.site_id
        WHERE o.site_id=s AND o.order_reference='S'||s||'-C'||j||'-SHP' AND oi.product_ref=refE
        LIMIT 1;

        IF v_prod_id IS NOT NULL THEN
          PERFORM 1 FROM order_item_substitutes
          WHERE site_id=s AND order_item_id=v_prod_id AND substitute_product_ref=refEALT;
          IF NOT FOUND THEN
            INSERT INTO order_item_substitutes (
              site_id, order_item_id, substitute_product_ref, substitute_catalog_ref, substitute_catalog_code,
              substitute_quantity, substitute_description, substitute_import, created_by
            ) VALUES (
              s, v_prod_id, refEALT, 'REF-'||refEALT, 'CAT-EALT',
              1, 'Sustituto de '||refE, 27.00, v_created_by
            );
          END IF;
        END IF;
      END IF;

      -- (D) INVOICED
      v_order_ref := 'S'||s||'-C'||j||'-INV';
      v_brand_for_order := v_brand2_id;
      v_amount    := 72.00; v_bi := round(v_amount/1.21, 2); v_tva := v_amount - v_bi;

      PERFORM 1 FROM orders o WHERE o.site_id=s AND o.order_reference=v_order_ref;
      IF NOT FOUND THEN
          INSERT INTO order_payments (site_id, order_id, payment_type, is_deferred, schedule_count, amount, created_by)
          VALUES (s, -1, 'tarjeta', FALSE, 1, v_amount, v_created_by)
          RETURNING order_payments_id INTO v_payment_id;

          INSERT INTO orders (
            site_id, order_datetime, order_reference, brand_id, order_source_id,
            action_id, action_category_id, action_priority_id,
            shipping_cost, customer_id, first_name, last_name, payment_type_id,
            is_paid, paid_at, is_invoiced, invoiced_at, order_lines, order_amount, bi1, tva1,
            status, created_by
          )
          VALUES (
            s, NOW() - INTERVAL '3 days', v_order_ref, v_brand_for_order, v_source_web_id,
            v_action_ver, v_category_id, v_priority_id,
            6.00, v_customer_id, v_fn, v_ln, v_payment_id,
            TRUE, NOW() - INTERVAL '3 days', TRUE, NOW() - INTERVAL '2 days',
            2, v_amount, v_bi, v_tva, 'invoiced', v_created_by
          )
          RETURNING order_id INTO v_order_id;

          UPDATE order_payments SET order_id=v_order_id
          WHERE site_id=s AND order_payments_id=v_payment_id;

          SELECT p.product_id INTO v_prod_id FROM products p WHERE p.site_id=s AND p.product_ref=refF;
          INSERT INTO order_items (site_id, order_id, line_number, product_id, product_ref, quantity, product_description, unit_price, line_total, created_by)
          VALUES (s, v_order_id, 1, v_prod_id, refF, 1, 'Articulo F'||j, 40.00, 40.00, v_created_by);

          SELECT p.product_id INTO v_prod_id FROM products p WHERE p.site_id=s AND p.product_ref=refG;
          INSERT INTO order_items (site_id, order_id, line_number, product_id, product_ref, quantity, product_description, unit_price, line_total, created_by)
          VALUES (s, v_order_id, 2, v_prod_id, refG, 1, 'Articulo G'||j, v_amount-40.00, v_amount-40.00, v_created_by);

          IF NOT EXISTS (
            SELECT 1 FROM order_payment_schedules
            WHERE site_id=s AND order_payments_id=v_payment_id AND schedule_number=1
          ) THEN
            INSERT INTO order_payment_schedules (
              site_id, order_payments_id, schedule_number, amount, due_date, is_paid, paid_date, created_by
            ) VALUES (s, v_payment_id, 1, v_amount, NOW() - INTERVAL '3 days', TRUE, NOW() - INTERVAL '3 days', v_created_by);
          END IF;

          IF NOT EXISTS (
            SELECT 1 FROM invoicing i WHERE i.site_id=s AND i.order_reference=v_order_ref
          ) THEN
            INSERT INTO invoicing (
              site_id, invoicing_date, invoice_number, customer_code, first_name, last_name,
              order_reference, bi1, tva1, total, created_by
            )
            VALUES (
              s, NOW() - INTERVAL '2 days', 'FAC-'||s||'-'||v_customer_code, v_customer_code, v_fn, v_ln,
              v_order_ref, v_bi, v_tva, v_amount, v_created_by
            );
          END IF;
      END IF;

      -- (E) CANCELLED
      v_order_ref := 'S'||s||'-C'||j||'-CXL';
      v_brand_for_order := v_brand1_id;
      v_amount    := 28.00; v_bi := round(v_amount/1.21, 2); v_tva := v_amount - v_bi;

      PERFORM 1 FROM orders o WHERE o.site_id=s AND o.order_reference=v_order_ref;
      IF NOT FOUND THEN
        INSERT INTO order_payments (site_id, order_id, payment_type, is_deferred, schedule_count, amount, created_by)
        VALUES (s, -1, 'efectivo', FALSE, 1, v_amount, v_created_by)
        RETURNING order_payments_id INTO v_payment_id;

        INSERT INTO orders (
          site_id, order_datetime, order_reference, brand_id, order_source_id,
          action_id, action_category_id, action_priority_id,
          shipping_cost, customer_id, first_name, last_name, payment_type_id,
          is_paid, paid_at, is_invoiced, invoiced_at, order_lines, order_amount, bi1, tva1,
          status, is_annulled, annulled_at, annulled_by, created_by
        )
        VALUES (
          s, NOW() - INTERVAL '1 day', v_order_ref, v_brand_for_order, v_source_web_id,
          v_action_prim, v_category_id, v_priority_id,
          2.50, v_customer_id, v_fn, v_ln, v_payment_id,
          FALSE, NULL, FALSE, NULL, 1, v_amount, v_bi, v_tva,
          'cancelled', TRUE, NOW() - INTERVAL '1 day', v_created_by, v_created_by
        )
        RETURNING order_id INTO v_order_id;

        UPDATE order_payments SET order_id=v_order_id
        WHERE site_id=s AND order_payments_id=v_payment_id;

        SELECT p.product_id INTO v_prod_id FROM products p WHERE p.site_id=s AND p.product_ref=refA;
        INSERT INTO order_items (
          site_id, order_id, line_number, product_id, product_ref, quantity,
          product_description, unit_price, line_total, created_by
        )
        VALUES (s, v_order_id, 1, v_prod_id, refA, 1, 'Articulo Cancelado '||j, v_amount, v_amount, v_created_by);
      END IF;

    END LOOP; -- clientes
  END LOOP; -- sites
END$$;

-- =====================================================================
-- Backfill de direcciones de pedido (idempotente, mantiene nombres reales)
-- =====================================================================
DO $$
DECLARE r RECORD; v_created_by bigint := (SELECT user_id FROM users WHERE email='ilopez@parcelontime.es' LIMIT 1);
BEGIN
  FOR r IN
    SELECT o.order_id, o.site_id, o.order_reference,
           o.first_name AS ofn, o.last_name AS oln,
           c.billing_first_name AS bfn, c.billing_last_name AS bln,
           c.billing_address_line1 AS baddr1, c.billing_address_line2 AS baddr2, 
           c.billing_address_line3 AS baddr3, c.billing_address_line4 AS baddr4, 
           c.billing_address_cp AS bcp, c.billing_address_city AS bcity, c.billing_mobile_phone AS bphone,
           c.shipping_first_name AS sfn, c.shipping_last_name AS sln,
           c.shipping_address_line1 AS saddr1, c.shipping_address_line2 AS saddr2, 
           c.shipping_address_line3 AS saddr3, c.shipping_address_line4 AS saddr4, 
           c.shipping_address_cp AS scp, c.shipping_address_city AS scity, c.shipping_mobile_phone AS sphone
    FROM orders o
    LEFT JOIN customers c ON c.site_id=o.site_id AND c.customer_id=o.customer_id
    WHERE o.site_id IN (
      (SELECT site_id FROM sites WHERE site_name='MAYLIS'),
      (SELECT site_id FROM sites WHERE site_name='MIRECAR'),
      (SELECT site_id FROM sites WHERE site_name='INSPMUSEES')
    )
      AND NOT EXISTS (
        SELECT 1 FROM order_addresses oa 
        WHERE oa.site_id=o.site_id AND oa.order_id=o.order_id
      )
  LOOP
    INSERT INTO order_addresses (
      order_id, site_id, order_reference,
      billing_customer_name, billing_address_line1, billing_address_line2, billing_address_line3, billing_address_line4, billing_postal_code, billing_city, billing_mobile_phone,
      shipping_customer_name, shipping_address_line1, shipping_address_line2, shipping_address_line3, shipping_address_line4, shipping_postal_code, shipping_city, shipping_mobile_phone,
      created_by
    )
    VALUES (
      r.order_id, r.site_id, r.order_reference,
      COALESCE(r.bfn || ' ' || r.bln, r.ofn || ' ' || r.oln, 'Cliente Seed'),
      COALESCE(r.baddr1, 'Direcci√≥n ' || r.site_id), r.baddr2, r.baddr3, r.baddr4, r.bcp, r.bcity, r.bphone,
      COALESCE(r.sfn || ' ' || r.sln, r.ofn || ' ' || r.oln, 'Cliente Seed'),
      COALESCE(r.saddr1, COALESCE(r.baddr1, 'Direcci√≥n ' || r.site_id)), r.saddr2, r.saddr3, r.saddr4, COALESCE(r.scp, r.bcp), COALESCE(r.scity, r.bcity), COALESCE(r.sphone, r.bphone),
      v_created_by
    );
  END LOOP;
END$$;